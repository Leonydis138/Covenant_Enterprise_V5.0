name: CI/CD

permissions:
  contents: read
  packages: write

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.12'
  NODE_VERSION: '20'
  NEXT_TELEMETRY_DISABLED: 1
  DOCKER_BUILDKIT: 1

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─────────────────────────────────────────────────────────────
  # CHECK FRONTEND EXISTENCE
  # ─────────────────────────────────────────────────────────────
  check-frontend:
    runs-on: ubuntu-latest
    outputs:
      has_frontend: ${{ steps.check.outputs.has_frontend }}
    steps:
      - uses: actions/checkout@v4
      - id: check
        run: |
          if [ -f frontend/package.json ]; then
            echo "has_frontend=true" >> $GITHUB_OUTPUT
          else
            echo "has_frontend=false" >> $GITHUB_OUTPUT
          fi

  # ─────────────────────────────────────────────────────────────
  # BACKEND TESTS (with PYTHONPATH fix)
  # ─────────────────────────────────────────────────────────────
  backend-test:
    name: Backend Tests (Python ${{ matrix.python }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python: [ '3.11', '3.12' ]
      fail-fast: false
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test_db
        ports: [ "5432:5432" ]
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      redis:
        image: redis:7-alpine
        ports: [ "6379:6379" ]
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python }}
          cache: pip
          cache-dependency-path: backend/requirements*.txt
      - name: Install backend dependencies
        working-directory: backend
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt
      - name: Run tests with coverage
        working-directory: backend
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/test_db
          REDIS_URL: redis://localhost:6379
          PYTHONPATH: src
        run: |
          pytest tests/ \
            --cov=src \
            --cov-report=xml \
            --cov-report=term
      - name: Upload coverage to Codecov
        if: always()
        uses: codecov/codecov-action@v4
        with:
          files: backend/coverage.xml
          flags: backend
          fail_ci_if_error: false

  # ─────────────────────────────────────────────────────────────
  # FRONTEND TESTS (conditional, with manual caching and fallbacks)
  # ─────────────────────────────────────────────────────────────
  frontend-test:
    name: Frontend (Next.js)
    runs-on: ubuntu-latest
    needs: check-frontend
    if: needs.check-frontend.outputs.has_frontend == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Check for lock file and compute hash
        id: lock-check
        working-directory: frontend
        run: |
          if [ -f package-lock.json ]; then
            echo "lock_file=package-lock.json" >> $GITHUB_OUTPUT
            echo "cache_key=npm-${{ runner.os }}-$(sha256sum package-lock.json | awk '{print $1}')" >> $GITHUB_OUTPUT
          elif [ -f yarn.lock ]; then
            echo "lock_file=yarn.lock" >> $GITHUB_OUTPUT
            echo "cache_key=yarn-${{ runner.os }}-$(sha256sum yarn.lock | awk '{print $1}')" >> $GITHUB_OUTPUT
          elif [ -f pnpm-lock.yaml ]; then
            echo "lock_file=pnpm-lock.yaml" >> $GITHUB_OUTPUT
            echo "cache_key=pnpm-${{ runner.os }}-$(sha256sum pnpm-lock.yaml | awk '{print $1}')" >> $GITHUB_OUTPUT
          else
            echo "lock_file=none" >> $GITHUB_OUTPUT
            echo "cache_key=npm-${{ runner.os }}-no-lock" >> $GITHUB_OUTPUT
          fi

      - name: Restore node_modules cache
        uses: actions/cache@v4
        id: cache-restore
        with:
          path: frontend/node_modules
          key: ${{ steps.lock-check.outputs.cache_key }}
          restore-keys: |
            npm-${{ runner.os }}-
            yarn-${{ runner.os }}-
            pnpm-${{ runner.os }}-

      - name: Install dependencies
        working-directory: frontend
        run: npm install --legacy-peer-deps

      - name: Type check
        working-directory: frontend
        run: npm run type-check
        continue-on-error: true

      - name: Lint
        working-directory: frontend
        run: npm run lint
        continue-on-error: true

      - name: Build
        working-directory: frontend
        run: npm run build

      - name: Save node_modules cache
        if: steps.cache-restore.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: frontend/node_modules
          key: ${{ steps.lock-check.outputs.cache_key }}

  # ─────────────────────────────────────────────────────────────
  # DOCKER BUILD
  # ─────────────────────────────────────────────────────────────
  docker-build:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]
    outputs:
      backend_tags: ${{ steps.docker-tags.outputs.backend_tags }}
      frontend_tags: ${{ steps.docker-tags.outputs.frontend_tags }}
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Set Docker tags
        id: docker-tags
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          BRANCH_TAG=$(echo "${GITHUB_REF_NAME}" | tr / -)
          echo "backend_tags=${BRANCH_TAG}-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "frontend_tags=${BRANCH_TAG}-${SHORT_SHA}" >> $GITHUB_OUTPUT
      - name: Build backend image
        uses: docker/build-push-action@v5
        with:
          context: backend
          push: false
          tags: |
            covenant-backend:${{ steps.docker-tags.outputs.backend_tags }}
            covenant-backend:${{ github.ref_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Build frontend image
        uses: docker/build-push-action@v5
        with:
          context: frontend
          push: false
          tags: |
            covenant-frontend:${{ steps.docker-tags.outputs.frontend_tags }}
            covenant-frontend:${{ github.ref_name }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ─────────────────────────────────────────────────────────────
  # DOCKER PUSH
  # ─────────────────────────────────────────────────────────────
  docker-push:
    name: Docker Push
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - uses: actions/checkout@v4
      - uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Push backend image
        uses: docker/build-push-action@v5
        with:
          context: backend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/covenant-backend:${{ needs.docker-build.outputs.backend_tags }}
            ${{ secrets.DOCKER_USERNAME }}/covenant-backend:${{ github.ref_name }}
          cache-from: type=gha
      - name: Push frontend image
        uses: docker/build-push-action@v5
        with:
          context: frontend
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/covenant-frontend:${{ needs.docker-build.outputs.frontend_tags }}
            ${{ secrets.DOCKER_USERNAME }}/covenant-frontend:${{ github.ref_name }}
          cache-from: type=gha
      - name: Push latest tag (main only)
        if: github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKER_USERNAME }}/covenant-backend:latest
            ${{ secrets.DOCKER_USERNAME }}/covenant-frontend:latest

  # ─────────────────────────────────────────────────────────────
  # DEPLOY TO STAGING WITH HEALTH CHECK & ROLLBACK
  # ─────────────────────────────────────────────────────────────
  deploy-staging:
    name: Deploy to Staging with Health Check
    runs-on: ubuntu-latest
    needs: [docker-push, docker-build]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify required secrets are set
        run: |
          if [ -z "${{ secrets.STAGING_SSH_KEY }}" ]; then
            echo "STAGING_SSH_KEY is not set"
            exit 1
          fi
          if [ -z "${{ secrets.STAGING_USER }}" ]; then
            echo "STAGING_USER is not set"
            exit 1
          fi
          if [ -z "${{ secrets.STAGING_HOST }}" ]; then
            echo "STAGING_HOST is not set"
            exit 1
          fi

      - name: Install SSH Client
        run: sudo apt-get update && sudo apt-get install -y openssh-client

      - name: Setup SSH Key
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.STAGING_SSH_KEY }}

      - name: Deploy with health checks and rollback
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          BACKEND_TAG: ${{ needs.docker-build.outputs.backend_tags }}
          FRONTEND_TAG: ${{ needs.docker-build.outputs.frontend_tags }}
          STAGING_USER: ${{ secrets.STAGING_USER }}
          STAGING_HOST: ${{ secrets.STAGING_HOST }}
        run: |
          ssh -o StrictHostKeyChecking=no ${STAGING_USER}@${STAGING_HOST} bash << 'EOF'
            set -e
            DOCKER_USERNAME="${DOCKER_USERNAME}"
            BACKEND_TAG="${BACKEND_TAG}"
            FRONTEND_TAG="${FRONTEND_TAG}"
            COMPOSE_FILE="/backend/docker-compose.yml"
            echo "Pulling new images..."
            docker pull ${DOCKER_USERNAME}/covenant-backend:${BACKEND_TAG}
            docker pull ${DOCKER_USERNAME}/covenant-frontend:${FRONTEND_TAG}
            docker pull ${DOCKER_USERNAME}/covenant-backend:develop || true
            docker pull ${DOCKER_USERNAME}/covenant-frontend:develop || true
            CURRENT_BACKEND=$(docker ps -qf "name=backend" || true)
            CURRENT_FRONTEND=$(docker ps -qf "name=frontend" || true)
            if [ -n "$CURRENT_BACKEND" ] || [ -n "$CURRENT_FRONTEND" ]; then
              echo "Stopping current containers..."
              docker compose -f ${COMPOSE_FILE} stop
            fi
            export BACKEND_IMAGE=${DOCKER_USERNAME}/covenant-backend:${BACKEND_TAG}
            export FRONTEND_IMAGE=${DOCKER_USERNAME}/covenant-frontend:${FRONTEND_TAG}
            echo "Starting new containers..."
            docker compose -f ${COMPOSE_FILE} up -d
            health_check() {
              local url=$1
              local max_attempts=30
              local attempt=1
              local delay=2
              while [ $attempt -le $max_attempts ]; do
                if curl -sSf --max-time 5 "$url" > /dev/null; then
                  return 0
                fi
                echo "Health check attempt $attempt/$max_attempts for $url failed. Retrying in ${delay}s..."
                sleep $delay
                attempt=$((attempt + 1))
              done
              return 1
            }
            echo "Waiting for services to become healthy..."
            if ! health_check "http://localhost:8000/health"; then
              echo "Backend health check failed! Rolling back..."
              docker compose -f ${COMPOSE_FILE} down
              if [ -n "$CURRENT_BACKEND" ]; then
                docker start $CURRENT_BACKEND
              fi
              if [ -n "$CURRENT_FRONTEND" ]; then
                docker start $CURRENT_FRONTEND
              fi
              exit 1
            fi
            if ! health_check "http://localhost:3000"; then
              echo "Frontend health check failed! Rolling back..."
              docker compose -f ${COMPOSE_FILE} down
              if [ -n "$CURRENT_BACKEND" ]; then
                docker start $CURRENT_BACKEND
              fi
              if [ -n "$CURRENT_FRONTEND" ]; then
                docker start $CURRENT_FRONTEND
              fi
              exit 1
            fi
            if [ -n "$CURRENT_BACKEND" ]; then
              docker rm $CURRENT_BACKEND || true
            fi
            if [ -n "$CURRENT_FRONTEND" ]; then
              docker rm $CURRENT_FRONTEND || true
            fi
            echo "Staging deployment successful ✅"
          EOF
